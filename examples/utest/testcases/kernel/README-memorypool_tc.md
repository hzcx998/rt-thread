    Date        Author        Email                      Notes
    2019-04-15  WillianChan   chentingwei@rt-thread.com  the first version
    2019-11-28  WillianChan   chentingwei@rt-thread.com  cancel the test that the three
                                                         parameters of size, block_count,
                                                         block_size in the memory pool
                                                         are zero

## 1、介绍

这里介绍的是内存池相关接口的测试用例，由于内存池相关接口的相关实现代码在 `rt-thread/src` 目录下，所有相关的测试用例就放到了 `testcases-latest/src/memory` 目录结构里。

该测试用例用于测试内存池相关接口功能是否正常。

## 2、文件说明

| 文件名 | 说明 |
| :--- | :--- |
| memorypool_tc.c | 内存池操作接口测试用例 |

## 3、软硬件环境

运行该测试用例需要在 `menuconfig` 中打开 `memorypool` 测试用例接口，硬件需要支持运行RT-Thread嵌入式操作系统，软件上支持相关内存池内核接口。

## 4、测试项

### 4.1 测试说明

| 测试项 | 说明 |
| :--- | :--- |
| 静态初始化方式读写测试 | 设置多个不同大小的内存池和不同容量的内存块进行测试，且测试内存池总大小或者内存块容量大小为0的特殊情况 |
| 动态创建方式读写测试 | 创建多个不同内存块数量和不同内存块容量大小的内存池进行测试，且测试当内存块数量或者内存块容量大小为0的特殊情况 |
| 静态初始化方式挂起测试 | 以静态的方式去测试无内存块申请线程挂起的情况 |
| 动态创建方式挂起测试 | 以动态的方式去测试无内存块申请线程挂起的情况 |

### 4.2 测试顺序

```
static void testcase(void)
{
    UTEST_UNIT_RUN(test_static_rw);
    UTEST_UNIT_RUN(test_dynamic_rw);
    UTEST_UNIT_RUN(test_static_suspend);
    UTEST_UNIT_RUN(test_dynamic_suspend);
}
```

### 4.3 测试思路

#### 4.3.1 静态初始化方式读写测试 `UTEST_UNIT_RUN(test_static_rw)` 测试思路

已知内存块数量×每个内存块容量大小=内存池总大小，在初始化内存池的时候，内存池总大小和内存块容量大小能直接影响申请的内存池块个数，初始化时需要设置多个不同大小的内存池和不同容量的内存块进行测试。

具体测试思路如下：

* 静态初始化一个内存池，判断所初始化的内存池是否正常完整，若初始化失败则返回 `-RT_ERROR`；
* 向内存池申请内存块直至内存池中没有内存块可以分配，如果分配内存块失败，释放前面申请的全部内存块，脱离内存池，返回 `-RT_ERROR`，测试不通过；
* 向每一块分配的内存块写入数据，每次写完一个内存块判断第一个数据是否与写入的相同，若不相同则释放前面申请的全部内存块，脱离内存池，返回 `-RT_ERROR`，测试不通过；
* 读取每个内存块的数据，判断每个内存块与之前写入的数据是否相同，如果有一个数据不匹配将释放所有的内存块，脱离内存池，返回 `-RT_ERROR`，测试不通过，如果正确则返回 `RT_EOK`；
* 释放掉所有的内存块，脱离内存池，测试通过；

#### 4.3.2 动态创建方式读写测试 `UTEST_UNIT_RUN(test_dynamic_rw)` 测试思路

已知内存块数量×每个内存块容量大小=内存池总大小，需创建多个不同内存块数量和不同内存块容量大小的内存池进行测试。

具体测试思路如下：

* 动态创建一个内存池，判断所创建的内存池是否正常完整，若创建失败则返回 `-RT_ERROR`，测试不通过；
* 向内存池申请内存块直至内存池中没有内存块可以分配，如果分配内存块时失败，释放前面申请的全部内存块，删除内存池，返回 `-RT_ERROR`，测试不通过；
* 向每一块分配的内存块写入数据，每次写完一个内存块判断第一个数据是否与写入的相同，若不相同则释放前面申请的全部内存块，删除内存池，返回 `-RT_ERROR`，测试不通过；
* 读取每个内存块的数据，判断每个内存块与之前写入的数据是否相同，如果有一个数据不匹配将释放所有的内存块，删除内存池，返回 `-RT_ERROR`，测试不通过，如果正确则返回 `RT_EOK`；
* 释放掉所有的内存块，脱离内存池，测试通过；

#### 4.3.3 静态初始化方式挂起测试 `UTEST_UNIT_RUN(test_static_suspend)` 测试思路

具体测试思路如下：

* 静态初始化一个内存池，并判断所初始化的内存池是否正常完整，若初始化失败则返回 `-RT_ERROR`，测试不通过；
* 创建信号量 `mp_sem`，创建分配线程 `mp_thread1` 和释放线程 `mp_thread2`，分配线程优先级高于释放线程优先级，如果创建信号量或者线程失败，则脱离内存池，返回 `-RT_ERROR`，测试不通过；
* 分配线程向内存池申请内存块直至内存池中没有内存块可以分配，如果分配内存块失败，释放前面申请的全部内存块，释放信号量 `mp_sem`，异常标志位 `mp_excp` 置为 `RT_TRUE`，结束线程，测试不通过；
* 分配线程再次申请一个内存块，等待挂起，申请到内存块后判断内存块是否为 `RT_NULL`，设置挂起标志位 `mp_suspend_flag` 为0，试图获取信号量 `mp_sem`；
* 释放线程试图获取信号量 `mp_sem`，判断异常标志位 `mp_excp` 是否为 `RT_TRUE`，若是则结束线程；
* 释放线程判断挂起标志位 `mp_suspend_flag` 是否为1，若为1则释放一个内存块，并将该内存块置为 `RT_NULL`，释放信号量 `mp_sem`，否则直接释放信号量 `mp_sem`；
* 分配线程判断释放线程释放的内存块是否为空，如果不为空则释放所有内存块，结束线程，测试不通过；
* 向新分配的内存块写入数据并读出数据，判断是否一致，释放新分配的内存块，结束线程；
* 释放线程释放全部内存块，结束线程，删除信号量，脱离内存池，返回 `RT_EOK`，测试通过。

#### 4.3.4 动态创建方式挂起测试 `UTEST_UNIT_RUN(test_dynamic_suspend)` 测试思路

具体测试思路如下：

* 动态创建一个内存池，判断所创建的内存池是否正常完整，若创建失败则返回 `-RT_ERROR`，测试不通过；
* 创建信号量 `mp_sem`，创建分配线程 `mp_thread1` 和释放线程 `mp_thread2`，分配线程优先级高于释放线程优先级，如果创建信号量或者线程失败，则删除内存池，返回 `-RT_ERROR`，测试不通过；
* 分配线程向内存池申请内存块直至内存池中没有内存块可以分配，如果分配内存块失败，释放前面申请的全部内存块，释放信号量 `mp_sem`，异常标志位 `mp_excp` 置为 `RT_TRUE`，结束线程，测试不通过；
* 分配线程再次申请一个内存块，等待挂起，申请到内存块后判断内存块是否为 `RT_NULL`，设置挂起标志位 `mp_suspend_flag` 为0，试图获取信号量 `mp_sem`；
* 释放线程试图获取信号量 `mp_sem`，判断异常标志位 `mp_excp` 是否为 `RT_TRUE`，若是则结束线程；
* 释放线程判断挂起标志位 `mp_suspend_flag` 是否为1，若为1则释放一个内存块，并将该内存块置为 `RT_NULL`，释放信号量 `mp_sem`，否则直接释放信号量 `mp_sem`；
* 分配线程判断释放线程释放的内存块是否为空，如果不为空则释放所有内存块，结束线程，测试不通过；
* 向新分配的内存块写入数据并读出数据，判断是否一致，释放新分配的内存块，结束线程；
* 释放线程释放全部内存块，结束线程，删除信号量，脱离内存池，返回 `RT_EOK`，测试通过。

## 5、配置

使用该测试用例时需要配置该测试用例，在 `menuconfig` 中的配置如下：

```
Privated Packages of RealThread --->
    [*] testcase: enable   --->
        test for kernel  --->
            memory  --->
                [*] Enable memorypool test
```

配置完成后，使用 `pkgs --update` 更新软件包。

## 6、使用

- 编译下载
- 在 MSH 中输入 `utest_run src.memory.memorypool_tc` 运行该测试用例。

## 7、注意事项

- 系统需要足够的内存大小来保证初始化创建内存池、线程、信号量成功，内存大小至少大于4096个字节
